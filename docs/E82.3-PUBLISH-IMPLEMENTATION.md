# E82.3: Publish Audit Log + Backlinks Implementation

## Overview

This implementation provides idempotent publishing of INTENT issue sets to GitHub with full audit trail and backlink tracking. The system ensures that duplicate executions do not create duplicate GitHub issues and maintains complete traceability of all publishing operations.

## Architecture

### Database Schema

#### `intent_issue_set_publish_batches`
Tracks each publishing batch with:
- Unique batch ID and request ID for traceability
- Issue set and session references
- Lawbook version at time of publish
- Status tracking (pending → in_progress → completed/failed)
- Summary counts (created, updated, skipped, failed)
- Batch hash for idempotency

#### `intent_issue_set_publish_items`
Records individual item publishing with:
- Canonical ID for issue identification
- GitHub issue number and URL
- Action taken (created/updated/skipped/failed)
- Status (success/failed)
- Error details if failed
- Rendered issue hash for change detection
- Labels applied

### Idempotency Strategy

**Canonical ID Resolution:**
1. Each issue has a unique canonical ID (e.g., `E82.1`)
2. Before publishing, query `cr_github_issue_audit` to find existing GitHub issue
3. If found: update the issue
4. If not found: create new issue
5. Record action in both ledger tables

**Batch Hash:**
- Generated from `issue_set_id + source_hash`
- Enables duplicate batch detection
- Ensures same content → same hash

### API Endpoint

**POST** `/api/intent/sessions/[id]/issue-set/publish/execute`

**Request:**
```json
{
  "owner": "adaefler-art",
  "repo": "codefactory-control"
}
```

**Response:**
```json
{
  "success": true,
  "batch_id": "uuid",
  "summary": {
    "total": 5,
    "created": 3,
    "updated": 2,
    "skipped": 0,
    "failed": 0
  },
  "items": [
    {
      "canonical_id": "E82.1",
      "action": "created",
      "status": "success",
      "github_issue_number": 42,
      "github_issue_url": "https://github.com/...",
      "rendered_issue_hash": "abc123...",
      "labels_applied": ["afu9", "epic-e82"]
    }
  ],
  "links": {
    "batch_id": "uuid",
    "request_id": "req-xyz"
  }
}
```

### Guard Order (E82.3 Requirement)

1. **401 Unauthorized**: Missing authentication
2. **409 Conflict**: Production block (unless `ISSUE_SET_PUBLISHING_ENABLED=true`)
3. **403 Forbidden**: Session ownership check
4. **GH/DB Operations**: GitHub API and database operations

### Security Features

**Production Block:**
- Publishing blocked in production by default
- Requires explicit environment variable: `ISSUE_SET_PUBLISHING_ENABLED=true`
- Prevents accidental mass issue creation

**Append-Only Audit:**
- Database triggers prevent UPDATE/DELETE on ledger tables
- Ensures immutable audit trail
- Complete traceability from batch to individual items

**Input Validation:**
- Owner/repo format validation
- Session ownership verification
- Issue set commit status check

## Usage Example

```typescript
// 1. Create and commit issue set
const issueSet = await generateIssueSet(pool, sessionId, userId, briefing, drafts);
await commitIssueSet(pool, sessionId, userId);

// 2. Publish to GitHub
const result = await publishIssueSet(pool, sessionId, {
  owner: 'adaefler-art',
  repo: 'codefactory-control',
  request_id: 'req-123',
  user_id: userId,
});

// 3. Check results
console.log(`Created: ${result.data.summary.created}`);
console.log(`Updated: ${result.data.summary.updated}`);
console.log(`Failed: ${result.data.summary.failed}`);

// 4. Query audit trail
const batches = await queryPublishBatches(pool, issueSetId);
const items = await queryPublishItems(pool, batchId);
```

## Error Handling

### Per-Item Errors
- Individual items can fail without affecting others
- Error message and details recorded in ledger
- Batch continues processing remaining items
- Summary includes failure count

### Batch-Level Errors
- Pre-flight checks (authentication, permissions)
- Session not found or access denied
- Issue set not committed
- Database connection errors

## Testing

**Test Coverage:**
- Hash generation and consistency
- Batch creation and querying
- Item creation with success/failure states
- Query operations by batch and canonical ID
- Error handling and recovery

**Run Tests:**
```bash
npm --prefix control-center test -- __tests__/lib/intent-issue-set-publish-ledger.test.ts
```

## Monitoring and Observability

**Request Tracing:**
- Every request has unique `x-request-id`
- Propagated through entire call chain
- Stored in both batch and item records

**Audit Queries:**
```sql
-- Find all batches for an issue set
SELECT * FROM intent_issue_set_publish_batches 
WHERE issue_set_id = $1 
ORDER BY created_at DESC;

-- Find publish history for a canonical ID
SELECT * FROM intent_issue_set_publish_items 
WHERE canonical_id = $1 
ORDER BY created_at DESC;

-- Get batch summary
SELECT 
  status,
  total_items,
  created_count + updated_count + skipped_count + failed_count as processed,
  created_count,
  updated_count,
  skipped_count,
  failed_count
FROM intent_issue_set_publish_batches
WHERE id = $1;
```

## Migration Path

1. Deploy migration 056
2. Deploy updated control-center code
3. Enable publishing in staging: `ISSUE_SET_PUBLISHING_ENABLED=true`
4. Test with sample issue sets
5. Monitor audit logs
6. Enable in production when ready

## Future Enhancements

- **Batch retry**: Retry failed items automatically
- **Webhook integration**: Notify external systems of publish events
- **Rate limiting**: Respect GitHub API rate limits
- **Parallel publishing**: Process items in parallel (with rate limiting)
- **Dry-run mode**: Preview changes without creating issues
- **Incremental publishing**: Publish only changed items

## References

- Issue E82.3: Publish Audit Log + Backlinks
- Migration: `database/migrations/056_intent_issue_set_publish_ledger.sql`
- Database Layer: `control-center/src/lib/db/intentIssueSetPublishLedger.ts`
- Publisher Service: `control-center/src/lib/github-issue-publisher.ts`
- API Endpoint: `control-center/app/api/intent/sessions/[id]/issue-set/publish/execute/route.ts`
- Tests: `control-center/__tests__/lib/intent-issue-set-publish-ledger.test.ts`
