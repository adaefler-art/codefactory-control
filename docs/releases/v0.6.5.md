---
Doc-ID: RELEASE-V065
Version: v0.6.5
Status: CANONICAL
Last-Updated: 2025-12-30
---

# AFU-9 Release v0.6.5 — Security Hardening

**Release Version:** v0.6.5  
**Status:** COMPLETE  
**Release Date:** 2025-12-30  
**Epic:** E66 (I661)  
**Type:** Security & Hardening

---

## Overview

v0.6.5 is a security-focused release that makes the AFU-9 repository "safe-by-default" by preventing secrets from entering the codebase through comprehensive scanning, protection gates, and sanitization procedures.

**Key Achievement:** Zero secrets in code — enforced through automated CI gates, git history scanning, and push protection.

---

## Done ✅

### 1. Secret Scanning Infrastructure

**Implementation:**
- ✅ Gitleaks integration with full git history scanning
- ✅ Custom `.gitleaks.toml` configuration for AFU-9 patterns
- ✅ CI workflow: `.github/workflows/security-gates.yml`
- ✅ `fetch-depth: 0` for complete history scanning
- ✅ Built-in + custom secret patterns (GitHub tokens, AWS keys, OpenAI keys)

**Evidence:**
- Workflow file: `.github/workflows/security-gates.yml`
- Configuration: `.gitleaks.toml`
- Documentation: `docs/v065/SECRET_SCANNING_SETUP.md`

**Verification:**
```bash
# Local verification
gitleaks detect --source . --config .gitleaks.toml --verbose

# CI runs on every push/PR
# GitHub Actions → security-gates workflow
```

---

### 2. Repository Structure Hardening

**Implementation:**
- ✅ Enhanced `.gitignore` with comprehensive secret patterns
- ✅ Updated `scripts/repo-verify.ts` with secret file detection
- ✅ Forbidden paths check in CI (`.env.local`, `*.pem`, `private-key-*.json`)
- ✅ Documentation of modification rules in root `README.md`

**Patterns Added to `.gitignore`:**
```gitignore
# Secrets and credentials
.env.local
.env.*.local
*.pem
private-key-*.json
secrets.json
credentials.json

# GitHub App private keys
github-app-*.pem
github-app-*.key
```

**Verification:**
```bash
npm run repo:verify
# Checks for forbidden paths and secret patterns
```

---

### 3. Git History Sanitization Procedures

**Implementation:**
- ✅ Documentation: `docs/v065/HISTORY_REWRITE.md`
- ✅ Step-by-step sanitization workflow
- ✅ Team re-clone coordination procedures
- ✅ Prevention strategies

**Tools Documented:**
- git-filter-repo (recommended)
- BFG Repo-Cleaner (alternative)
- git filter-branch (legacy)

**Use Cases:**
- Secrets found in git history
- Coordinating team-wide re-clone
- Investigating history rewrite options

---

### 4. Secret Rotation Documentation

**Implementation:**
- ✅ Documentation: `docs/v065/SECURITY_ROTATION.md`
- ✅ Rotation status for all AFU-9 secrets
- ✅ Verification evidence (working tree + history scans)
- ✅ Best practices for secret storage
- ✅ Incident response procedures

**Secrets Covered:**
- GitHub Personal Access Tokens (PAT)
- AWS IAM Access Keys
- OpenAI API Keys
- Database credentials
- GitHub App private keys

---

### 5. CI Security Gates

**Implementation:**
- ✅ `repo-verify.yml` — Enhanced with secret file patterns check
- ✅ `security-gates.yml` — Gitleaks scanning (history + working tree)
- ✅ `security-validation.yml` — IAM policy validation (existing)

**Gate Logic:**
1. **repo-verify.yml** runs on every push
   - Route-map check
   - Forbidden paths check
   - Empty folders check
   - Secret file patterns check (NEW in v0.6.5)

2. **security-gates.yml** runs on every PR
   - Gitleaks secret scanning (full history)
   - Forbidden file detection
   - Blocks PR if secrets detected

3. **security-validation.yml** runs on infrastructure changes
   - IAM least privilege validation
   - Resource scope validation

---

### 6. Documentation & Procedures

**Implementation:**
- ✅ `docs/v065/README.md` — Security hardening overview
- ✅ `docs/v065/SECRET_SCANNING_SETUP.md` — GitHub secret scanning setup
- ✅ `docs/v065/HISTORY_REWRITE.md` — Git history sanitization
- ✅ `docs/v065/SECURITY_ROTATION.md` — Secret rotation evidence
- ✅ Updated root `README.md` with security section

**Quick Reference:**
- Emergency response procedures
- Verification checklist
- CI/CD integration guide
- Evidence: Git history scanning proof

---

## Not Done ❌

### 1. GitHub Secret Scanning Configuration

**Status:** MANUAL ACTION REQUIRED  
**Reason:** Requires GitHub repository admin access (UI configuration)

**Required Actions:**
1. Navigate to: Repository Settings → Security → Code security and analysis
2. Enable "Secret scanning"
3. Enable "Push protection"
4. (Optional) Add custom secret patterns for AFU-9-specific secrets

**Documentation:** `docs/v065/SECRET_SCANNING_SETUP.md`

---

### 2. Team Notification & Training

**Status:** MANUAL ACTION REQUIRED  
**Reason:** Communication and coordination needed

**Required Actions:**
1. Notify team of new security gates
2. Share documentation (docs/v065/)
3. Conduct security training session
4. Monitor for false positives in first week

**Communication Plan:**
- Slack/Teams announcement
- Email to all contributors
- Update CONTRIBUTING.md with security guidelines

---

### 3. Custom Secret Patterns

**Status:** OPTIONAL  
**Reason:** Built-in patterns cover most cases

**Future Enhancement:**
- Add AFU-9-specific secret patterns to GitHub secret scanning
- Examples: deployment tokens, custom API keys, service account credentials

**Documentation:** `docs/v065/SECRET_SCANNING_SETUP.md` (section: Custom Patterns)

---

## Breaking Changes ⚠️

### 1. Git History Rewrite (If Secrets Found)

**Impact:** CRITICAL  
**Scenario:** If secrets are discovered in git history

**Required Actions:**
1. Revoke exposed secret immediately
2. Run git-filter-repo to sanitize history
3. Force push sanitized history
4. All team members must re-clone repository

**Documentation:** `docs/v065/HISTORY_REWRITE.md`

**Coordination:**
```bash
# Notification to team
Subject: [SECURITY] Repository re-clone required

The git history has been sanitized to remove exposed secrets.
All team members must:

1. Backup local work: git stash
2. Delete local repository
3. Re-clone: git clone <repo-url>
4. Re-apply local work: git stash pop

Timeline: Complete by [DATE]
```

---

### 2. Enhanced .gitignore (May Require Manual Cleanup)

**Impact:** LOW  
**Scenario:** Previously tracked files now ignored

**Affected Files:**
- `.env.local` files
- `*.pem` files
- `private-key-*.json` files

**Required Actions:**
```bash
# If you have tracked files that are now ignored:
git rm --cached .env.local
git rm --cached **/*.pem
git commit -m "chore: remove ignored secret files from tracking"
```

---

### 3. New CI Gates (May Block Existing PRs)

**Impact:** MEDIUM  
**Scenario:** Existing PRs with secrets will be blocked

**Required Actions:**
1. Review security-gates.yml output
2. Remove any flagged secrets
3. Revoke exposed secrets
4. Re-push clean commits

**False Positives:**
- Mark as allowed in `.gitleaks.toml` (allowlist)
- Document in PR why it's not a real secret

---

## Migration Guide

### From v0.6 to v0.6.5

#### 1. Update Local Repository

```bash
# Pull latest changes
git pull origin main

# Verify no secrets in working tree
find . -name ".env.local" -o -name "*.pem" | grep -v node_modules

# Run repo verification
npm run repo:verify
```

#### 2. Install Gitleaks (Optional for local scanning)

```powershell
# Windows
winget install gitleaks

# macOS
brew install gitleaks

# Linux
# See https://github.com/gitleaks/gitleaks#installation
```

#### 3. Update CI/CD Pipelines

No changes required — security gates automatically apply to all branches.

#### 4. Review Secrets Storage

```bash
# Ensure all secrets are in AWS Secrets Manager or .env.local (gitignored)
# Remove any hardcoded secrets from code

# Check for common patterns
grep -r "GITHUB_TOKEN" .
grep -r "AWS_ACCESS_KEY_ID" .
grep -r "OPENAI_API_KEY" .
```

#### 5. Verify Deployment

```bash
# Test local development
npm run dev:control-center

# Verify CI gates pass
git push  # Should trigger security-gates workflow
```

---

## Operations Notes

### CI/CD Changes

**New Workflows:**
- `.github/workflows/security-gates.yml` — Runs on every PR
  - Duration: ~2-3 minutes
  - Blocks merge if secrets detected
  - Required status check (enforce in branch protection)

**Modified Workflows:**
- `.github/workflows/repo-verify.yml` — Enhanced with secret file patterns check
  - Duration: ~1 minute (no significant change)
  - Now checks for `.env.local`, `*.pem`, etc.

**Recommended Branch Protection:**
```yaml
# Add to branch protection rules (main branch)
required_status_checks:
  - security-gates
  - repo-verify
  - tests
```

---

### Monitoring & Alerts

**Gitleaks Alerts:**
- Location: GitHub Actions → Security tab → Code scanning alerts
- Severity: All secrets flagged as CRITICAL
- Response time: < 1 hour (revoke immediately)

**Secret Scanning Alerts (GitHub native):**
- Location: Repository Settings → Security → Secret scanning alerts
- Automated: GitHub detects and alerts on known patterns
- Push protection: Prevents accidental commits

**Metrics to Track:**
- Number of secrets detected (should be 0)
- False positive rate (tune `.gitleaks.toml` if high)
- Time to revoke exposed secrets (target: < 1 hour)

---

### Incident Response

**If Secret is Exposed:**

1. **Immediate (< 1 hour):**
   ```bash
   # Revoke the secret
   # GitHub PAT: Settings → Developer Settings → Revoke
   # AWS Key: IAM Console → Disable key
   # OpenAI: OpenAI Dashboard → Revoke key
   ```

2. **Short-term (< 4 hours):**
   ```bash
   # Remove from repository
   git rm -f <secret-file>
   git commit -m "security: remove exposed secret"
   git push

   # Check git history
   git log --all --name-only -- <secret-file>
   ```

3. **Long-term (< 1 day):**
   ```bash
   # If in history, sanitize
   # Follow docs/v065/HISTORY_REWRITE.md

   # Generate new secret
   # Update AWS Secrets Manager
   # Verify integrations work

   # Document in docs/v065/SECURITY_ROTATION.md
   ```

---

## Rollback Plan

**If v0.6.5 causes issues:**

### Option 1: Disable Security Gates (Temporary)

```yaml
# .github/workflows/security-gates.yml
# Comment out or set to manual trigger

on:
  pull_request:  # Remove this
  workflow_dispatch:  # Add this for manual only
```

### Option 2: Revert to v0.6

```bash
# Revert commits
git revert <v0.6.5-commit-range>
git push

# Remove security gates
git rm .github/workflows/security-gates.yml
git commit -m "revert: remove security gates"
git push
```

**Impact:** Security vulnerabilities (secrets in code) will not be detected.

---

## Testing Verification

### Automated Tests

```bash
# Unit tests (no new tests added)
npm test

# Repo verification
npm run repo:verify
# Should pass with secret file patterns check

# Local Gitleaks scan
gitleaks detect --source . --config .gitleaks.toml --verbose
# Should output: ○ No leaks found
```

### Manual Testing

- [ ] Push commit with `.env.local` file → Should be blocked by security-gates
- [ ] Push commit with `private-key-123.pem` → Should be blocked
- [ ] Push commit with a fake token string in code → Should be detected by Gitleaks
- [ ] Run `npm run repo:verify` → Should pass
- [ ] Check GitHub Actions → security-gates workflow → Should be green

---

## Related Documentation

- **[v0.6.5 Overview](../../v065/README.md)** - Security hardening overview
- **[Secret Scanning Setup](../../v065/SECRET_SCANNING_SETUP.md)** - GitHub secret scanning
- **[History Rewrite](../../v065/HISTORY_REWRITE.md)** - Git history sanitization
- **[Security Rotation](../../v065/SECURITY_ROTATION.md)** - Secret rotation evidence
- **[v0.6 Release](../v0.6/RELEASE.md)** - Foundation release
- **[Root README](../../../README.md)** - Security workflow section

---

## Version Compatibility

| Component | v0.6 | v0.6.5 | Notes |
|-----------|------|--------|-------|
| Control Center | ✅ | ✅ | No breaking changes |
| Database Schema | ✅ | ✅ | No schema changes |
| API Contracts | ✅ | ✅ | No API changes |
| CI Workflows | ✅ | ✅ | New security-gates.yml |
| .gitignore | ⚠️ | ✅ | Enhanced patterns (may require cleanup) |
| Git History | ⚠️ | ✅ | May require rewrite if secrets found |

---

## Success Criteria (Verification)

- [x] Gitleaks CI workflow configured with `fetch-depth: 0`
- [x] `.gitleaks.toml` includes AFU-9 custom patterns
- [x] `.gitignore` enhanced with secret file patterns
- [x] `repo-verify.ts` checks for forbidden secret files
- [x] Documentation complete (docs/v065/)
- [x] Root README.md updated with security section
- [ ] GitHub secret scanning enabled (MANUAL)
- [ ] Push protection enabled (MANUAL)
- [ ] Team notified and trained (MANUAL)

---

**Maintained by:** AFU-9 Security Team  
**Last Updated:** 2025-12-30  
**Status:** COMPLETE (pending manual GitHub config)  
**Related Epic:** E66 (I661)
