# Automated Workflow Debugging Agent

## Overview

The Automated Workflow Debugging Agent monitors the "Deploy AFU-9 to ECS" workflow for failures and automatically collects diagnostic information, analyzes errors, and provides actionable debugging suggestions.

This eliminates the manual copy-paste process between GitHub Actions and VS Code Copilot, streamlining the debugging workflow.

## Components

### 1. GitHub Actions Workflow (`debug-deploy-failures.yml`)

**Location**: `.github/workflows/debug-deploy-failures.yml`

**Triggers**:
- **Automatic**: When `deploy-ecs.yml` workflow fails
- **Manual**: Via workflow_dispatch with optional run ID

**Features**:
- Automatically collects workflow run details and failed job information
- Downloads workflow logs
- Collects ECS service diagnostics (when AWS credentials are available)
- Generates AI-ready debugging prompts
- Creates GitHub issues with comprehensive failure analysis
- Adds debugging artifacts to workflow run

**Outputs**:
- `debug-info.json` - Structured failure data
- `ai-debug-prompt.txt` - AI-ready analysis prompt
- `ecs-services.json` - ECS service diagnostics (optional)
- `ecs-stopped-tasks.json` - Recent stopped tasks (optional)
- GitHub issue with complete analysis

### 2. Standalone Analysis Script (`analyze-workflow-failure.js`)

**Location**: `scripts/analyze-workflow-failure.js`

**Usage**:
```bash
# Analyze specific workflow run
GITHUB_TOKEN=<token> node scripts/analyze-workflow-failure.js --run-id <run_id>

# Analyze latest failed deployment
GITHUB_TOKEN=<token> node scripts/analyze-workflow-failure.js --latest-failure

# Create GitHub issue with analysis
GITHUB_TOKEN=<token> node scripts/analyze-workflow-failure.js --latest-failure --create-issue

# Verbose mode
GITHUB_TOKEN=<token> node scripts/analyze-workflow-failure.js --latest-failure --verbose
```

**Features**:
- Pattern matching for common deployment errors
- Categorized error detection (AWS auth, DB migrations, ECS, etc.)
- Automatic recommendations based on error patterns
- JSON and Markdown report generation
- GitHub issue creation
- Can be used locally or in CI/CD

**Environment Variables**:
- `GITHUB_TOKEN` (required) - GitHub personal access token or Actions token
- `GITHUB_REPOSITORY` (optional) - Format: `owner/repo` (auto-detected in Actions)

## Usage Scenarios

### Scenario 1: Automatic Debugging on Failure

When `deploy-ecs.yml` fails:
1. `debug-deploy-failures.yml` automatically triggers
2. Collects all diagnostic information
3. Creates a GitHub issue with:
   - Failed job and step details
   - Error pattern analysis
   - Debugging recommendations
   - Links to relevant documentation
   - AI-ready prompt for further analysis

### Scenario 2: Manual Debugging of Past Failures

```bash
# Run the debugging workflow manually
gh workflow run debug-deploy-failures.yml

# Or analyze locally
export GITHUB_TOKEN="<your-token>"
node scripts/analyze-workflow-failure.js --latest-failure --create-issue
```

### Scenario 3: AI-Assisted Debugging

1. Copy the content from `ai-debug-prompt.txt` (generated by the workflow)
2. Paste into your AI assistant (VS Code Copilot, ChatGPT, Claude, etc.)
3. Get detailed analysis and fix suggestions
4. Or use the prompt in automated GitHub issue for team collaboration

## Error Pattern Detection

The analyzer automatically detects and categorizes common deployment errors:

| Pattern | Category | Recommendation |
|---------|----------|----------------|
| AWS credentials | AWS Authentication | Check AWS_DEPLOY_ROLE_ARN secret and OIDC configuration |
| Database migration | Database Migration | Check database connectivity, migration scripts, and RDS security groups |
| ECS service | ECS Deployment | Check ECS service exists, task definition is valid, and IAM roles are correct |
| Task definition | Task Definition | Verify task definition JSON, container images, and secret ARNs |
| Preflight/gate | Preflight Check | Review preflight.sh output and CDK diff for infrastructure changes |
| Health/ready | Health Check | Check ALB target health, container health checks, and application startup |
| Secrets Manager | Secrets Management | Verify secrets exist in AWS Secrets Manager and have correct keys |
| Docker/ECR | Container Build | Check Dockerfile, build context, and ECR permissions |

## Integration with AFU-9 Architecture

The debugging agent aligns with AFU-9's deployment guardrails:

- **Respects Deploy System Prompt**: References canonical deployment documentation
- **Non-Invasive**: Only observes and analyzes, doesn't modify infrastructure
- **Structured Output**: Provides JSON and Markdown reports for both humans and automation
- **Safety-Critical Aware**: Highlights violations of deployment constraints

## Configuration

### GitHub Actions Workflow

Edit `.github/workflows/debug-deploy-failures.yml` to customize:

```yaml
env:
  AWS_REGION: eu-central-1  # Change if using different region

jobs:
  debug-workflow:
    # Customize failure conditions
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event.workflow_run.conclusion == 'failure')
```

### Analysis Script

The script can be extended with additional error patterns:

```javascript
// In scripts/analyze-workflow-failure.js
const patterns = [
  {
    pattern: /your-pattern/i,
    category: 'Your Category',
    recommendation: 'Your recommendation'
  },
  // Add more patterns...
];
```

## Permissions

The workflow requires the following GitHub Actions permissions:

```yaml
permissions:
  actions: read      # Read workflow runs and jobs
  contents: read     # Read repository content
  issues: write      # Create debugging issues
  id-token: write    # AWS OIDC authentication (optional)
```

## Output Examples

### GitHub Issue
Created automatically with:
- Workflow run link and metadata
- Failed jobs and steps
- Error pattern analysis
- Debugging recommendations
- AI-ready prompt (collapsed)
- Links to documentation

### JSON Analysis
```json
{
  "run_id": 123456,
  "run_number": 42,
  "run_url": "https://github.com/...",
  "conclusion": "failure",
  "failed_jobs": [
    {
      "name": "Build and Deploy to ECS",
      "failed_steps": [
        {
          "name": "Run database migrations (gate)",
          "number": 15
        }
      ]
    }
  ],
  "error_patterns": [
    {
      "category": "Database Migration",
      "detected_in": "Run database migrations (gate)"
    }
  ],
  "recommendations": [
    "Check database connectivity, migration scripts, and RDS security groups"
  ]
}
```

## Troubleshooting

### Workflow doesn't trigger automatically

- Check that `workflow_run` trigger is properly configured
- Verify the workflow name matches exactly: `"Deploy AFU-9 to ECS"`
- Ensure the workflow is on the default branch

### Missing AWS diagnostics

- AWS diagnostics are optional and continue on error
- Check that `AWS_DEPLOY_ROLE_ARN` secret is configured
- Verify OIDC provider is set up correctly

### Script fails with authentication error

- Ensure `GITHUB_TOKEN` environment variable is set
- Token needs `repo` and `workflow` scopes
- In GitHub Actions, use `${{ secrets.GITHUB_TOKEN }}`

## Future Enhancements

Potential improvements:

1. **LLM Integration**: Direct integration with OpenAI/Anthropic APIs for automated analysis
2. **Auto-Fix PRs**: Generate and submit fix PRs for common issues
3. **Trend Analysis**: Track and report on recurring failure patterns
4. **Slack/Teams Notifications**: Real-time alerts to team channels
5. **Root Cause Database**: Build knowledge base of failures and solutions
6. **Predictive Analysis**: Identify potential issues before deployment

## Related Documentation

- [Deploy System Prompt](../docs/deploy/AFU9_DEPLOY_SYSTEM_PROMPT.md) - Deployment guardrails
- [Deploy Checklist](../docs/deploy/AFU9_DEPLOY_CHECKLIST.md) - Deployment steps
- [Deployment Consolidated Guide](../docs/DEPLOYMENT_CONSOLIDATED.md) - Complete deployment guide
- [ECS Deployment](../docs/ECS-DEPLOYMENT.md) - ECS-specific details
- [Observability](../docs/OBSERVABILITY.md) - Monitoring and logging

## License

This debugging agent is part of the AFU-9 codefactory-control system and follows the same license.
