# AFU9 Handler Compare: S1 vs S2 vs S3

## Matrix

| Stage | Action (UI) | UI endpoint (browser -> UI) | UI proxy file + handler fn | UI proxy passthrough | Engine client call | Engine -> Control endpoint | Control route file | Runtime hint | Auth/client factory | Auth env keys used | Repo/installation resolution | Preconditions | Error mapping | Response headers expected | Response body envelope |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| S1 | Link GitHub Issue | /api/control/afu9/s1s3/issues/pick | codefactory-ui/src/app/api/control/[...path]/route.ts -> proxyRequest (GET/POST/PUT/PATCH/DELETE/OPTIONS) | Forwards: cookie, authorization, content-type, accept, user-agent, x-request-id, x-cf-trace. Sets x-request-id, x-afu9-request-id, x-cf-trace, x-afu9-route, x-afu9-method, x-afu9-auth-path=ui-control-proxy, x-ui-* build headers; rebuilds response from upstream text. | UI uses controlFetch (codefactory-ui/src/lib/api/controlClient.ts). Engine has pickIssueHandler -> proxyToControl (codefactory-engine/packages/engine/src/api/s1s3Handlers.ts). | /api/afu9/s1s3/issues/pick (engine proxy path); control base URL from CONTROL_CENTER_BASE_URL/CONTROL_CENTER_URL | control-center/app/api/afu9/s1s3/issues/pick/route.ts | UI proxy runtime=nodejs; engine handlers on express/node; control route default/unknown | createAuthenticatedClient (control-center/src/lib/github/auth-wrapper.ts) | S1 route: none; helper chain uses GITHUB_APP_ID, GH_APP_ID, GITHUB_APP_PRIVATE_KEY_PEM, GH_APP_PRIVATE_KEY_PEM, GITHUB_APP_SECRET_ID, GH_APP_SECRET_ID, AWS_REGION, AWS_DEFAULT_REGION, NEXT_PUBLIC_AWS_REGION; policy uses GITHUB_REPO_ALLOWLIST. | Repo from request body repo (owner/repo); issueNumber from request body. GitHub App installation resolved in github-app-auth via getInstallationIdForRepo. | Repo/issue number validation; repo format; GitHub issue exists; allowlist/policy check via auth wrapper. | errorResponse on validation/auth failures; 401/403 for auth. | UI proxy adds x-afu9-* + x-ui-*; control uses response-helpers (x-afu9-request-id, x-afu9-handler=control, x-afu9-auth-path=control, x-afu9-route) plus x-cf-handler. | S1 route comment says issue/run/step response; exact envelope from route implementation. |
| S2 | Save Spec + Sync to GitHub | /api/control/afu9/s1s9/issues/{id}/spec | codefactory-ui/src/app/api/control/[...path]/route.ts -> proxyRequest (POST) | Same as S1. | UI uses controlFetch (codefactory-ui/src/lib/api/controlClient.ts) via s2SaveSpec (codefactory-ui/src/lib/api/afu9GatewayClient.ts). Engine has specIssueHandler -> proxyToControl (codefactory-engine/packages/engine/src/api/s1s3Handlers.ts). | /api/afu9/s1s3/issues/:id/spec (engine proxy path; scope s1s9 used by UI, control routes accept s1s9 via wrapper) | control-center/app/api/afu9/s1s3/issues/[id]/spec/route.ts | UI proxy runtime=nodejs; engine handlers on express/node; control route default/unknown | syncAfu9SpecToGitHubIssue -> createAuthenticatedClient (control-center/src/lib/github/issue-sync.ts, auth-wrapper) | Route uses SERVICE_READ_TOKEN, DEBUG_SERVICE_AUTH, NODE_ENV. Stage registry check uses GITHUB_APP_ID, GH_APP_ID, GITHUB_APP_PRIVATE_KEY_PEM, GH_APP_PRIVATE_KEY_PEM, GITHUB_APP_SECRET_ID, GH_APP_SECRET_ID. Auth helper uses AWS_REGION, AWS_DEFAULT_REGION, NEXT_PUBLIC_AWS_REGION; policy uses GITHUB_REPO_ALLOWLIST. | Repo from issue repo_full_name; issueNumber from github_issue_number; owner/repo derived from repo_full_name. GitHub App installation resolved in github-app-auth via getInstallationIdForRepo. | Service token check; stage registry config via resolveStageMissingConfig; issue state validation; acceptanceCriteria validation; mirror metadata presence; sync blocked if config missing. | spec_* error codes; githubSync status set to BLOCKED/FAILED with errorCode (e.g., GITHUB_WRITE_DENIED); errors include x-afu9-error-code. | getControlResponseHeaders sets x-afu9-request-id, x-afu9-handler=control, x-afu9-auth-path=control, x-afu9-route; response headers add x-afu9-stage, x-afu9-handler=control.s1s3.spec, x-cf-handler=s1s3-spec; UI proxy adds x-afu9-method/route and x-ui-* build headers. | Response includes issue/run/step, s2 fields, githubSync object (status, message, errorCode). |
| S3 | Trigger Implementation | /api/control/afu9/s1s9/issues/{id}/implement | codefactory-ui/src/app/api/control/[...path]/route.ts -> proxyRequest (POST) | Same as S1. | UI uses controlFetch (codefactory-ui/src/lib/api/controlClient.ts) via s3Implement (codefactory-ui/src/lib/api/afu9GatewayClient.ts). Engine has implementIssueHandler (custom mapping) (codefactory-engine/packages/engine/src/api/s1s3Handlers.ts). | /api/afu9/s1s3/issues/:id/implement (engine proxy path; engine handler switches to s1s9 based on URL) | control-center/app/api/afu9/s1s3/issues/[id]/implement/route.ts; wrapper control-center/app/api/afu9/s1s9/issues/[id]/implement/route.ts | UI proxy runtime=nodejs; engine handlers on express/node; control route default/unknown | createAuthenticatedClient in route + triggerAfu9Implementation with injected octokit (control-center/src/lib/github/auth-wrapper.ts, control-center/src/lib/github/issue-sync.ts) | Route uses AFU9_STAGE, DEPLOY_ENV, ENVIRONMENT, AFU9_GITHUB_IMPLEMENT_LABEL, AFU9_GITHUB_IMPLEMENT_COMMENT, VERCEL_GIT_COMMIT_SHA, NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA, GIT_COMMIT_SHA, COMMIT_SHA; auth helper uses GITHUB_APP_ID, GH_APP_ID, GITHUB_APP_PRIVATE_KEY_PEM, GH_APP_PRIVATE_KEY_PEM, GITHUB_APP_SECRET_ID, GH_APP_SECRET_ID; policy uses GITHUB_REPO_ALLOWLIST; github-app-auth uses AWS_REGION, AWS_DEFAULT_REGION, NEXT_PUBLIC_AWS_REGION. | Repo from issue repo_full_name; issueNumber from github_issue_number; owner/repo from repo_full_name. GitHub App installation resolved in github-app-auth via getInstallationIdForRepo. | AFU9_STAGE present; issue exists; mirror metadata (repo_full_name + github_issue_number); issue status SPEC_READY/IMPLEMENTING/PR_CREATED; GitHub App config via createAuthenticatedClient; trigger config (AFU9_GITHUB_IMPLEMENT_LABEL/COMMENT). | Maps upstream status: 401/403 -> GITHUB_AUTH_INVALID; 404 -> GITHUB_TARGET_NOT_FOUND; 422 -> GITHUB_VALIDATION_FAILED; network -> GITHUB_UPSTREAM_UNREACHABLE; missing config -> GITHUB_AUTH_MISSING; proxy TypeError -> IMPLEMENT_PRECONDITION_FAILED. Engine handler maps only a small set of codes and can downgrade to INTERNAL_ERROR. | applyHandlerHeaders sets x-afu9-handler, x-afu9-handler-ver, x-afu9-commit, x-cf-handler; setAfu9Headers adds x-afu9-request-id, x-afu9-handler, x-afu9-control-build, x-afu9-auth-path. UI proxy adds x-afu9-method/route and x-ui-* build headers. | Control response includes issue/run/step/githubTrigger; engine handler returns minimal { ok, stage, runId, mutationId, issueId, startedAt } on success. |

## Key Diffs

- UI S2/S3 calls use controlFetch to /api/control/afu9/... (codefactory-ui/src/lib/api/afu9GatewayClient.ts); engine layer is present but not used by these UI actions.
- Engine S3 implement handler normalizes error codes to a smaller set and can return INTERNAL_ERROR even if control returns a more specific GITHUB_* code.
- Control S2 sync uses syncAfu9SpecToGitHubIssue (issue-sync) while S3 uses createAuthenticatedClient in the route and then triggerAfu9Implementation with injected octokit.
- S2 adds service token gating (SERVICE_READ_TOKEN) and spec validation before sync; S3 gates on AFU9_STAGE, mirror metadata, and trigger config (AFU9_GITHUB_IMPLEMENT_LABEL/COMMENT).
- S2 route uses getControlResponseHeaders (x-afu9-auth-path=control) while S3 sets x-afu9-auth-path to app/unknown in setAfu9Headers.
- S2 is scoped via /afu9/s1s9/issues/{id}/spec in UI, but S2 control route is /afu9/s1s3/... and accepts s1s9 via wrapper.
- Engine proxy adds x-cf-upstream-* header aliases for x-cf-* headers, which is not done in the UI proxy.
- UI proxy rebuilds response from upstream text and always sets cache-control: no-store and x-ui-* build headers.

## Hypothesen (ranked)

1. S3 409 precondition can be triggered by S3-only env gates (AFU9_STAGE or AFU9_GITHUB_IMPLEMENT_LABEL/COMMENT) that are not required for S2.
2. S3 uses route-level createAuthenticatedClient; if GitHub App config is missing, S3 returns GITHUB_AUTH_MISSING even if other UI operations appear functional.
3. Engine S3 handler can mask upstream GITHUB_* codes into INTERNAL_ERROR, hiding the underlying cause compared to direct control calls.
4. S2 path requires SERVICE_READ_TOKEN in control route; S3 path does not. Any mismatch in token handling could make S2 succeed while S3 fails at later preconditions.
5. UI proxy always sets x-afu9-auth-path=ui-control-proxy, while control sets app/unknown for S3; mismatched header expectations could lead to diagnostics differences across stages.
