# AFU-9 v0.4 — Staging Test Findings

**Related:** [docs/v04/V04_RELEASE_REVIEW.md](../v04/V04_RELEASE_REVIEW.md)

**Scope:** Findings captured from our real staging deployment/tests as reflected in repo artifacts (runbooks + reference identifiers + code guardrails).  
**Constraint:** Evidence must exist in-repo; no assumptions.  
**Date (evidence reference):** 2025-12-22 (see runbook identifiers)

---

## Finding 1 — ECS container healthcheck false-negative when probing 127.0.0.1

- **Symptom**
  - ECS tasks can be marked UNHEALTHY / roll back even when the service is reachable via ALB.

- **Repro**
  - Deploy the ECS task definition with a container healthcheck probing `http://127.0.0.1:3000/api/health` in this Fargate setup.

- **Expected / Actual**
  - **Expected:** The container healthcheck probe returns HTTP 200 from `/api/health` on the configured probe endpoint (task ENI IPv4 `10.x.x.x:3000`).
  - **Actual:** `127.0.0.1` probing can fail; the service is instead reachable via the task ENI IPv4 (`10.x.x.x`).

- **Evidence**
  - Runbook explicitly documents the root cause + the required fix (ENI IPv4 probing) and notes that `127.0.0.1` can be refused in this setup: [docs/runbooks/ecs-healthchecks.md](../runbooks/ecs-healthchecks.md)
  - ECS stack healthcheck implementation (control-center) now probes task ENI IP (see healthcheck code/logic): [lib/afu9-ecs-stack.ts](../../lib/afu9-ecs-stack.ts)

- **Impact**
  - Deploy instability: ECS circuit breaker / rollbacks due to incorrect health signal.

- **Fix idea**
  - Keep container healthcheck on `/api/health`, but probe via task ENI IPv4 for control-center.
  - Keep sidecars on loopback (`127.0.0.1:300X/health`) as documented.

---

## Finding 2 — Wrong health gate: ALB healthcheck on `/api/ready` causes rollback during startup

- **Symptom**
  - ALB target group health check returns 503 during startup when dependencies aren’t ready; ECS circuit breaker interprets as failure.

- **Repro**
  - Configure ALB health check to hit `/api/ready` while the service is starting or while dependencies are temporarily unavailable.

- **Expected / Actual**
  - **Expected:** Load balancer health checks should be “liveness” and not block deploys due to dependencies.
  - **Actual:** `/api/ready` is dependency-aware and can return 503, which can cascade into rollbacks.

- **Evidence**
  - Runbook documents the historical incident and the current state: ALB health check uses `/api/health`, `/api/ready` stays optional: [docs/runbooks/ecs-healthchecks.md](../runbooks/ecs-healthchecks.md)
  - ALB target group health check path is set to `/api/health` in `healthCheck.path` on the `ApplicationTargetGroup`: [bin/codefactory-control.ts](../../bin/codefactory-control.ts)

- **Impact**
  - False-negative health → rollbacks and degraded deploy determinism.

- **Fix idea**
  - Use `/api/health` for ALB and container healthchecks.
  - Keep `/api/ready` for manual verification or future readiness semantics.

---

## Finding 3 — Staging service can disappear (INACTIVE) due to deploy-mode mismatch or context toggle

- **Symptom**
  - Staging service (`afu9-control-center-staging`) may be missing/INACTIVE.

- **Repro**
  - In single-env mode: deploy with `afu9-create-staging-service=false` (removes the resource from the stack), or deploy with an incorrect mode expectation.

- **Expected / Actual**
  - **Expected:** Staging service existence is deterministic and safe.
  - **Actual:** A context toggle can remove the staging ECS service resource and lead to deletion.

- **Evidence**
  - Deploy process runbook documents both deployment modes and explicitly warns that toggling `afu9-create-staging-service=false` can delete staging: [docs/runbooks/deploy-process.md](../runbooks/deploy-process.md)

- **Impact**
  - Operational confusion (“staging missing”) and accidental destructive change.

- **Fix idea**
  - For single-env: pass `-c afu9-create-staging-service=true` explicitly in deploy commands.
  - Prefer `cdk diff` before deploy and use the diff gate.

---

## Finding 4 — DB secret drift / legacy “/master” secret usage causes runtime failures

- **Symptom**
  - ECS tasks fail to start or fail at runtime when DB secrets are misconfigured, especially when referencing legacy secrets containing `/master`.

- **Repro**
  - Deploy ECS with `dbSecretName` / `dbSecretArn` pointing to a legacy secret containing `/master` or to a secret missing required keys.

- **Expected / Actual**
  - **Expected:** ECS always references the canonical app secret and required keys exist.
  - **Actual:** Wrong secret/key mapping yields task initialization/runtime errors.

- **Evidence**
  - Canonical DB secret contract (name + required keys) and warning against `/master`: [docs/runbooks/deploy-process.md](../runbooks/deploy-process.md)
  - Preflight/guardrail documentation: [docs/v04/SECRET_VALIDATION.md](../v04/SECRET_VALIDATION.md)
  - CDK secret key validation helper: [lib/utils/secret-validator.ts](../../lib/utils/secret-validator.ts)
  - Database stack creates the canonical app connection secret `afu9/database` with required keys: [lib/afu9-database-stack.ts](../../lib/afu9-database-stack.ts)
  - ECS stack includes fail-fast guardrails blocking `/master` secret usage: [lib/afu9-ecs-stack.ts](../../lib/afu9-ecs-stack.ts)

- **Impact**
  - Hard deploy failures or unstable runtime.

- **Fix idea**
  - Standardize on `afu9/database` (keys: `host`, `port`, `database`, `username`, `password`).
  - Keep deploy-time validation (synth/build/deploy) mandatory; avoid bypass env vars except for local dev.

---

## Finding 5 — Diff gate must not be blocked by unrelated dependency stack diffs

- **Symptom**
  - Deploy safety checks can be incorrectly blocked by unrelated diffs (e.g., dependency stacks showing changes not relevant to the intended deployment).

- **Repro**
  - Run a diff gate that includes dependency stacks (instead of evaluating only the requested stack).

- **Expected / Actual**
  - **Expected:** Diff gate evaluates only the stack being deployed.
  - **Actual:** Including dependencies can surface unrelated “blocking” changes and block safe updates.

- **Evidence**
  - Diff gate script explicitly uses `cdk diff --exclusively` and documents the rationale: [scripts/validate-cdk-diff.ts](../../scripts/validate-cdk-diff.ts)

- **Impact**
  - Friction and false blocks in deployment workflow.

- **Fix idea**
  - Keep using `--exclusively` for diff gate.
  - Ensure runbooks always recommend stack-scoped diff before deploy.

---

## Non-blocking note (v0.4)

Self-Propelling was exercised/documented in the repo, but is now explicitly **deferred to v0.5** and treated as **non-blocking** for v0.4 release readiness.

Evidence of current implementation style (filesystem workflow definition load):
- [control-center/app/api/issues/[issueNumber]/self-propel/route.ts](../../control-center/app/api/issues/%5BissueNumber%5D/self-propel/route.ts)
