name: Security Gates

# I661 (E66) ‚Äî Repo Security Hardening
# Blocks PRs and commits with detected secrets or forbidden files

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # CRITICAL: Full git history required for gitleaks to scan all commits

      - name: Run Gitleaks Secret Scanning (History + Working Tree)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # Uncomment for Gitleaks Pro
        # EVIDENCE (I661/E66): This action runs 'gitleaks detect' which scans:
        # - Entire git history (all commits, all branches) when fetch-depth: 0
        # - Current working tree files
        # - Uses .gitleaks.toml for AFU-9 custom patterns + built-in rules
        # Default behavior: NO --no-git flag, full history scan enabled
        # Note: Gitleaks Pro provides additional features like custom rules and priority support.
        # For AFU-9, the free version is sufficient for basic secret scanning.
        # If using Gitleaks Pro, uncomment GITLEAKS_LICENSE above and add the license to repository secrets.

      - name: Secret Scan Summary
        if: success()
        run: |
          echo "## üîí Secret Scanning Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **No secrets detected**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Scanned for:" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Personal Access Tokens (PATs)" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub App tokens and private keys" >> $GITHUB_STEP_SUMMARY
          echo "- AWS access keys and session tokens" >> $GITHUB_STEP_SUMMARY
          echo "- OpenAI API keys" >> $GITHUB_STEP_SUMMARY
          echo "- Private SSH/RSA keys" >> $GITHUB_STEP_SUMMARY
          echo "- Database connection strings" >> $GITHUB_STEP_SUMMARY
          echo "- And 200+ other secret patterns" >> $GITHUB_STEP_SUMMARY

      - name: Secret Scan Failure Summary
        if: failure()
        run: |
          echo "## ‚ùå Secret Scanning FAILED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Secrets detected in repository!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Immediate Actions Required:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **DO NOT MERGE** this PR" >> $GITHUB_STEP_SUMMARY
          echo "2. **Review gitleaks output** above for detected secrets" >> $GITHUB_STEP_SUMMARY
          echo "3. **Remove secrets** from code and git history" >> $GITHUB_STEP_SUMMARY
          echo "4. **Rotate exposed secrets** immediately" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Documentation:" >> $GITHUB_STEP_SUMMARY
          echo "- [Security Rotation Guide](https://github.com/${{ github.repository }}/blob/main/docs/v065/SECURITY_ROTATION.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [History Rewrite Guide](https://github.com/${{ github.repository }}/blob/main/docs/v065/HISTORY_REWRITE.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [Secret Scanning Setup](https://github.com/${{ github.repository }}/blob/main/docs/v065/SECRET_SCANNING_SETUP.md)" >> $GITHUB_STEP_SUMMARY

  forbidden-files:
    name: Forbidden Files Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Secret Files
        id: check_secret_files
        shell: bash
        run: |
          echo "Scanning for forbidden secret files..."
          
          # Define forbidden patterns
          FORBIDDEN_PATTERNS=(
            ".env.local"
            "*.pem"
            "*.pkcs8.pem"
            "*private-key*"
            "secret-*.json"
            "github-app-secret.json"
            "*.key"
            "*.p12"
            "*.pfx"
          )
          
          FOUND_FILES=()
          
          # Search for each pattern
          for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
            # Use find with pattern matching, excluding specific directories
            while IFS= read -r file; do
              FOUND_FILES+=("$file")
            done < <(find . -name "$pattern" \
              -not -path "*/node_modules/*" \
              -not -path "*/.git/*" \
              -not -path "*/.next/*" \
              -not -path "*/dist/*" \
              -not -path "*/build/*" \
              -not -path "*/cdk.out/*" \
              -type f 2>/dev/null)
          done
          
          # Check results
          if [ ${#FOUND_FILES[@]} -gt 0 ]; then
            echo "‚ùå CRITICAL: Found ${#FOUND_FILES[@]} forbidden file(s):"
            printf '%s\n' "${FOUND_FILES[@]}"
            echo ""
            echo "These files must NEVER be committed!"
            echo ""
            echo "Immediate actions:"
            echo "1. Remove files: git rm --cached <file>"
            echo "2. Verify .gitignore includes these patterns"
            echo "3. Check git history: git log --all --name-only -- <file>"
            echo "4. If in history, see docs/v065/HISTORY_REWRITE.md"
            echo "5. If exposed, rotate secrets: docs/v065/SECURITY_ROTATION.md"
            echo ""
            exit 1
          else
            echo "‚úÖ No forbidden files found"
            exit 0
          fi

      - name: Forbidden Files Summary
        if: always()
        run: |
          echo "## üö´ Forbidden Files Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_secret_files.outcome }}" == "success" ]; then
            echo "‚úÖ **No forbidden files detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Checked for:" >> $GITHUB_STEP_SUMMARY
            echo "- \`.env.local\` files" >> $GITHUB_STEP_SUMMARY
            echo "- \`*.pem\` certificate/key files" >> $GITHUB_STEP_SUMMARY
            echo "- \`*private-key*\` files" >> $GITHUB_STEP_SUMMARY
            echo "- \`secret-*.json\` files" >> $GITHUB_STEP_SUMMARY
            echo "- Other key material (\`.key\`, \`.p12\`, \`.pfx\`)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Forbidden files detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "See workflow logs for details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üìñ [Security Rotation Guide](https://github.com/${{ github.repository }}/blob/main/docs/v065/SECURITY_ROTATION.md)" >> $GITHUB_STEP_SUMMARY
          fi

  repo-security-verify:
    name: Repository Security Verification
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Repository Security Verification
        id: repo_security
        shell: bash
        run: |
          set -o pipefail
          
          # Run repo:verify which includes secret file check
          npm run repo:verify 2>&1 | tee security_verification_output.txt
          EXIT_CODE=${PIPESTATUS[0]}
          
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit $EXIT_CODE

      - name: Security Verification Summary
        if: always()
        run: |
          echo "## üîê Repository Security Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.repo_security.outputs.exit_code }}" == "0" ]; then
            echo "‚úÖ **All repository security checks PASSED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Verified Security Checks:" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ No secret files in working tree" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ No forbidden paths (.next/, .worktrees/)" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Route-map consistency" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ No empty folders" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Proper scope separation" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Repository security verification FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "See workflow logs for detailed error messages" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Security Documentation:" >> $GITHUB_STEP_SUMMARY
            echo "- [Security Rotation](https://github.com/${{ github.repository }}/blob/main/docs/v065/SECURITY_ROTATION.md)" >> $GITHUB_STEP_SUMMARY
            echo "- [History Rewrite](https://github.com/${{ github.repository }}/blob/main/docs/v065/HISTORY_REWRITE.md)" >> $GITHUB_STEP_SUMMARY
            echo "- [Secret Scanning Setup](https://github.com/${{ github.repository }}/blob/main/docs/v065/SECRET_SCANNING_SETUP.md)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìã Full verification output available in workflow logs" >> $GITHUB_STEP_SUMMARY

      - name: Upload verification output
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: security-verification-output
          path: security_verification_output.txt
          retention-days: 30  # Keep security logs longer

  security-gate-summary:
    name: Security Gate Summary
    runs-on: ubuntu-latest
    needs: [secret-scanning, forbidden-files, repo-security-verify]
    if: always()
    permissions:
      contents: read
    
    steps:
      - name: Check All Gates
        run: |
          echo "## üîí Security Gates Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check each job result
          SECRET_SCAN="${{ needs.secret-scanning.result }}"
          FORBIDDEN_FILES="${{ needs.forbidden-files.result }}"
          REPO_SECURITY="${{ needs.repo-security-verify.result }}"
          
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "$SECRET_SCAN" == "success" ]; then
            echo "| Secret Scanning (Gitleaks) | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Secret Scanning (Gitleaks) | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$FORBIDDEN_FILES" == "success" ]; then
            echo "| Forbidden Files Check | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Forbidden Files Check | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$REPO_SECURITY" == "success" ]; then
            echo "| Repository Security Verify | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Repository Security Verify | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine overall status
          if [ "$SECRET_SCAN" == "success" ] && [ "$FORBIDDEN_FILES" == "success" ] && [ "$REPO_SECURITY" == "success" ]; then
            echo "### ‚úÖ All Security Gates Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Repository is secure and ready for merge." >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "### ‚ùå Security Gates Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required:** Review and fix security issues above before merging." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Quick Links:" >> $GITHUB_STEP_SUMMARY
            echo "- [Security Rotation Guide](https://github.com/${{ github.repository }}/blob/main/docs/v065/SECURITY_ROTATION.md)" >> $GITHUB_STEP_SUMMARY
            echo "- [History Rewrite Guide](https://github.com/${{ github.repository }}/blob/main/docs/v065/HISTORY_REWRITE.md)" >> $GITHUB_STEP_SUMMARY
            echo "- [Secret Scanning Setup](https://github.com/${{ github.repository }}/blob/main/docs/v065/SECRET_SCANNING_SETUP.md)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
