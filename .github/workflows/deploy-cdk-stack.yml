name: Deploy CDK Stack with Diff Gate

# ============================================================================
# CANONICAL DEPLOY GUARDRAILS (Single Source of Truth)
# - docs/deploy/AFU9_DEPLOY_SYSTEM_PROMPT.md
# - docs/deploy/AFU9_DEPLOY_CHECKLIST.md
# - docs/deploy/AFU9_DEPLOY_INTENT.md
#
# Workflow separation:
# - deploy-ecs.yml       => APP-ONLY (ECS task definition + service update)
# - deploy-cdk-stack.yml => INFRA (CDK deploy; DNS only if MANAGE_DNS=true)
#
# Do not widen IAM permissions or bypass preflight/diff gates.
# ============================================================================

on:
  workflow_dispatch:
    inputs:
      stack_name:
        description: 'CDK Stack to deploy'
        required: true
      environment:
        description: 'Deployment environment'
        required: true
        default: staging
      enable_https:
        description: 'Enable HTTPS (requires DNS stack)'
        required: false
        default: 'false'
      skip_diff_gate:
        description: 'Skip diff gate (NOT recommended)'
        required: false
        default: 'false'

env:
  AWS_REGION: eu-central-1
  DOMAIN_NAME: afu-9.com
  MANAGE_DNS: ${{ vars.AFU9_MANAGE_DNS || 'false' }}
  CREATE_STAGING_SERVICE: 'true'

jobs:
  validate-and-deploy:
    name: Validate Diff and Deploy CDK Stack
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate workflow inputs
        shell: bash
        run: |
          set -euo pipefail
          STACK_NAME='${{ github.event.inputs.stack_name }}'
          ENVIRONMENT='${{ github.event.inputs.environment }}'
          ENABLE_HTTPS='${{ github.event.inputs.enable_https }}'
          SKIP_DIFF_GATE='${{ github.event.inputs.skip_diff_gate }}'

          case "${STACK_NAME}" in
            Afu9NetworkStack|Afu9DatabaseStack|Afu9EcsStack|Afu9AlarmsStack|Afu9IamStack|Afu9DeployMemoryStack) ;;
            *) echo "❌ Invalid stack_name: ${STACK_NAME}" >&2; exit 1;;
          esac

          case "${ENVIRONMENT}" in
            staging|production) ;;
            *) echo "❌ Invalid environment: ${ENVIRONMENT}" >&2; exit 1;;
          esac

          case "${ENABLE_HTTPS}" in
            true|false) ;;
            *) echo "❌ Invalid enable_https (must be 'true' or 'false'): ${ENABLE_HTTPS}" >&2; exit 1;;
          esac

          case "${SKIP_DIFF_GATE}" in
            true|false) ;;
            *) echo "❌ Invalid skip_diff_gate (must be 'true' or 'false'): ${SKIP_DIFF_GATE}" >&2; exit 1;;
          esac

      - name: Guard AWS_DEPLOY_ROLE_ARN
        run: |
          if [ -z "${{ secrets.AWS_DEPLOY_ROLE_ARN }}" ]; then
            echo "❌ AWS_DEPLOY_ROLE_ARN is missing (secret is empty or undefined)" >&2
            exit 1
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Log resolved deploy context
        run: |
          echo "MANAGE_DNS=${{ env.MANAGE_DNS }}"
          echo "AFU9_ENABLE_HTTPS=${{ github.event.inputs.enable_https }}"
          echo "CREATE_STAGING_SERVICE=${{ env.CREATE_STAGING_SERVICE }}"
          echo "DOMAIN_NAME=${{ env.DOMAIN_NAME }}"

      - name: "Guard: prevent disabling HTTPS while routing stack exists"
        if: ${{ github.event.inputs.stack_name == 'Afu9NetworkStack' && github.event.inputs.enable_https != 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          if aws cloudformation describe-stacks --stack-name Afu9RoutingSingleEnvStack --region "${{ env.AWS_REGION }}" >/dev/null 2>&1; then
            echo "❌ Cannot deploy Afu9NetworkStack with enable_https=false while Afu9RoutingSingleEnvStack exists." >&2
            echo "This would cause CloudFormation export deletions to fail (exports are still imported by the routing stack)." >&2
            echo "Remediation: either (A) run this workflow with enable_https=true, or (B) destroy Afu9RoutingSingleEnvStack (and Afu9DnsStack if applicable) before disabling HTTPS." >&2
            exit 1
          fi

      - name: Verify AWS OIDC Authentication
        run: |
          echo "========================================="
          echo "Verifying AWS OIDC Authentication"
          echo "========================================="
          aws sts get-caller-identity
          echo ""
          echo "✅ AWS authentication successful"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build CDK project
        run: npm run build

      - name: "Guard: Block production deploys when ENABLE_PROD=false (Issue 3)"
        if: ${{ github.event.inputs.environment == 'production' }}
        run: |
          set -euo pipefail
          
          ENABLE_PROD="${{ vars.ENABLE_PROD || 'false' }}"
          
          echo "========================================="
          echo "Production Deploy Guard (Issue 3)"
          echo "========================================="
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "ENABLE_PROD: ${ENABLE_PROD}"
          echo ""
          
          if [ "${ENABLE_PROD}" != "true" ]; then
            echo "❌ BLOCKED: Production deploys are currently disabled"
            echo ""
            echo "Production environment is in cost-reduction mode (Issue 3)."
            echo "All work should be done in staging environment only."
            echo ""
            echo "To re-enable production deploys:"
            echo "  1. Set ENABLE_PROD=true in GitHub repository variables"
            echo "  2. Follow the re-enable procedure in docs/issues/ISSUE_3_PROD_DEACTIVATION.md"
            echo ""
            exit 1
          fi
          
          echo "✅ Production deploys are enabled - proceeding with deployment"
          echo ""

      - name: "CDK Diff Gate - Validate Changes"
        if: ${{ github.event.inputs.skip_diff_gate != 'true' }}
        run: |
          echo "========================================="
          echo "CDK Diff Gate Validation"
          echo "========================================="
          echo "Stack: ${{ github.event.inputs.stack_name }}"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "HTTPS Enabled: ${{ github.event.inputs.enable_https }}"
          echo ""
          
          # Run diff gate validation
          npm run validate:diff -- ${{ github.event.inputs.stack_name }} \
            -c environment=${{ github.event.inputs.environment }} \
            -c afu9-domain=${{ env.DOMAIN_NAME }} \
            -c afu9-multi-env=false \
            -c afu9-enable-https=${{ github.event.inputs.enable_https }} \
            -c afu9-manage-dns=${{ env.MANAGE_DNS }} \
            -c afu9-create-staging-service=${{ env.CREATE_STAGING_SERVICE }}

          echo "cdk diff args: -c environment=${{ github.event.inputs.environment }} -c afu9-domain=${{ env.DOMAIN_NAME }} -c afu9-multi-env=false -c afu9-enable-https=${{ github.event.inputs.enable_https }} -c afu9-manage-dns=${{ env.MANAGE_DNS }} -c afu9-create-staging-service=${{ env.CREATE_STAGING_SERVICE }}"
          
          DIFF_RESULT=$?
          
          if [ $DIFF_RESULT -eq 0 ]; then
            echo ""
            echo "✅ Diff gate PASSED - Safe to deploy"
          elif [ $DIFF_RESULT -eq 1 ]; then
            echo ""
            echo "❌ Diff gate BLOCKED - Contains blocking changes"
            echo "Review the blocking changes above and get approval before deploying"
            exit 1
          else
            echo ""
            echo "❌ Diff gate ERROR - Script failed"
            exit 2
          fi

      - name: "CDK Diff Gate - SKIPPED"
        if: ${{ github.event.inputs.skip_diff_gate == 'true' }}
        run: |
          echo "⚠️ ⚠️ ⚠️ WARNING ⚠️ ⚠️ ⚠️"
          echo "Diff gate validation has been SKIPPED"
          echo "This is NOT recommended for production deployments"
          echo "Proceed with extreme caution"
          echo ""

      - name: "Guard: Afu9DatabaseStack secret not pending deletion"
        if: ${{ github.event.inputs.stack_name == 'Afu9DatabaseStack' }}
        shell: bash
        run: |
          set -euo pipefail
          SECRET_ID="afu9/database"
          echo "Checking Secrets Manager state for: ${SECRET_ID}"

          # If secret does not exist, that's fine.
          if ! aws secretsmanager describe-secret --secret-id "${SECRET_ID}" --region "${{ env.AWS_REGION }}" >/dev/null 2>&1; then
            echo "✅ Secret does not exist yet; CDK can create it."
            exit 0
          fi

          DELETED_DATE=$(aws secretsmanager describe-secret --secret-id "${SECRET_ID}" --region "${{ env.AWS_REGION }}" --query 'DeletedDate' --output text)
          if [ "${DELETED_DATE}" != "None" ]; then
            echo "❌ Secret ${SECRET_ID} is marked for deletion (${DELETED_DATE}). CloudFormation cannot create/recreate a secret with this name." >&2
            echo "Remediation (pick ONE):" >&2
            echo "  1) Fastest: force-delete the scheduled secret so CDK can recreate it:" >&2
            echo "     aws secretsmanager delete-secret --secret-id ${SECRET_ID} --force-delete-without-recovery --region ${{ env.AWS_REGION }}" >&2
            echo "  2) Or wait until deletion completes (not practical if recovery window is large)." >&2
            echo "" >&2
            echo "If the stack is stuck in UPDATE_ROLLBACK_FAILED, also run:" >&2
            echo "  aws cloudformation continue-update-rollback --stack-name Afu9DatabaseStack --region ${{ env.AWS_REGION }}" >&2
            exit 1
          fi

          echo "✅ Secret exists and is active (not pending deletion)."

      - name: Deploy CDK Stack
        run: |
          echo "========================================="
          echo "Deploying CDK Stack"
          echo "========================================="
          echo "Stack: ${{ github.event.inputs.stack_name }}"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "HTTPS Enabled: ${{ github.event.inputs.enable_https }}"
          echo ""
          
          npx cdk deploy ${{ github.event.inputs.stack_name }} \
            --context environment=${{ github.event.inputs.environment }} \
            --context afu9-domain=${{ env.DOMAIN_NAME }} \
            --context afu9-multi-env=false \
            --context afu9-enable-https=${{ github.event.inputs.enable_https }} \
            --context afu9-manage-dns=${{ env.MANAGE_DNS }} \
            --context afu9-create-staging-service=${{ env.CREATE_STAGING_SERVICE }} \
            --require-approval never

      - name: Verify Deployment
        run: |
          echo "========================================="
          echo "Verifying Deployment"
          echo "========================================="
          
          # Check stack status
          STACK_STATUS=$(aws cloudformation describe-stacks \
            --stack-name ${{ github.event.inputs.stack_name }} \
            --query 'Stacks[0].StackStatus' \
            --output text)
          
          echo "Stack Status: $STACK_STATUS"
          
          if [[ "$STACK_STATUS" == *"COMPLETE"* ]]; then
            echo "✅ Stack deployment successful"
          elif [[ "$STACK_STATUS" == *"FAILED"* ]] || [[ "$STACK_STATUS" == *"ROLLBACK"* ]]; then
            echo "❌ Stack deployment failed or rolled back"
            
            # Get failure reason
            aws cloudformation describe-stack-events \
              --stack-name ${{ github.event.inputs.stack_name }} \
              --max-items 10 \
              --query 'StackEvents[?ResourceStatus==`CREATE_FAILED` || ResourceStatus==`UPDATE_FAILED`]'
            
            exit 1
          else
            echo "⚠️ Stack in intermediate state: $STACK_STATUS"
          fi

      - name: Get Stack Outputs
        run: |
          echo "========================================="
          echo "Stack Outputs"
          echo "========================================="
          
          aws cloudformation describe-stacks \
            --stack-name ${{ github.event.inputs.stack_name }} \
            --query 'Stacks[0].Outputs' \
            --output table

      - name: Deployment Summary
        if: always()
        run: |
          echo "## CDK Stack Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          STACK_STATUS=$(aws cloudformation describe-stacks \
            --stack-name ${{ github.event.inputs.stack_name }} \
            --query 'Stacks[0].StackStatus' \
            --output text 2>/dev/null || echo "UNKNOWN")
          
          if [[ "$STACK_STATUS" == *"COMPLETE"* ]]; then
            echo "✅ **Deployment completed successfully**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Deployment status: $STACK_STATUS**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration:" >> $GITHUB_STEP_SUMMARY
          echo "- Stack: \`${{ github.event.inputs.stack_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: \`${{ github.event.inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Region: \`${{ env.AWS_REGION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Diff Gate: \`${{ github.event.inputs.skip_diff_gate == 'true' && 'SKIPPED' || 'ENFORCED' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.skip_diff_gate }}" = "true" ]; then
            echo "⚠️ **WARNING:** Diff gate was skipped for this deployment" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- Verify stack outputs in AWS Console" >> $GITHUB_STEP_SUMMARY
          echo "- Run smoke tests if applicable" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor CloudWatch alarms" >> $GITHUB_STEP_SUMMARY
          echo "- See [AWS Deploy Runbook](../docs/AWS_DEPLOY_RUNBOOK.md)" >> $GITHUB_STEP_SUMMARY

# ============================================================================
# How to verify (read-only checks)
# - npx cdk diff Afu9EcsStack -c afu9-domain=afu-9.com -c afu9-multi-env=false -c afu9-enable-https=true -c afu9-manage-dns=false -c environment=prod
# - aws ecs list-services --cluster afu9-cluster --region eu-central-1
# - curl -s -H "Host: afu-9.com" https://<alb-dns>/api/ready
# ============================================================================