name: Auto-assign Deploy Failure Issues

on:
  issues:
    types: [opened, labeled]

permissions:
  issues: write

jobs:
  auto-assign-copilot:
    runs-on: ubuntu-latest
    if: |
      (
        contains(github.event.issue.title, 'Deploy Failure') ||
        contains(github.event.issue.title, 'Deployment Failed') ||
        contains(github.event.issue.labels.*.name, 'deploy-failure') ||
        contains(github.event.issue.labels.*.name, 'deployment') ||
        contains(github.event.issue.body, 'Debug Deploy Failures')
      ) &&
      !contains(github.event.issue.labels.*.name, 'copilot-assigned')
    
    steps:
      - name: Assign issue to Copilot review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            try {
              // Assign issue to adaefler-art
              await github.rest.issues.addAssignees({
                owner: owner,
                repo: repo,
                issue_number: issueNumber,
                assignees: ['adaefler-art']
              });
              console.log(`âœ… Assigned issue #${issueNumber} to adaefler-art`);
              
              // Add labels: copilot-assigned and auto-triage
              await github.rest.issues.addLabels({
                owner: owner,
                repo: repo,
                issue_number: issueNumber,
                labels: ['copilot-assigned', 'auto-triage']
              });
              console.log(`âœ… Added labels: copilot-assigned, auto-triage`);
              
              // Add comment
              const commentBody = 'ðŸ¤– **AFU-9 Auto-Triage**: Dieses Deploy-Failure-Issue wurde automatisch Copilot zur Analyse zugewiesen.\n\n_Workflow: Auto-assign Deploy Failure Issues_';
              
              await github.rest.issues.createComment({
                owner: owner,
                repo: repo,
                issue_number: issueNumber,
                body: commentBody
              });
              console.log(`âœ… Added auto-triage comment to issue #${issueNumber}`);
              
            } catch (error) {
              core.setFailed(`Failed to process issue: ${error.message}`);
              throw error;
            }
