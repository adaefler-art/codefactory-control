name: Deploy Database Stack

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "staging"
      enable_https:
        description: "Enable HTTPS (true/false)"
        required: false
        default: "false"
      skip_diff_gate:
        description: "Skip diff gate (true/false)"
        required: false
        default: "false"

env:
  AWS_REGION: eu-central-1
  DOMAIN_NAME: afu-9.com
  CREATE_STAGING_SERVICE: "true"

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail
          ENVIRONMENT='${{ inputs.environment }}'
          ENABLE_HTTPS='${{ inputs.enable_https }}'
          SKIP_DIFF_GATE='${{ inputs.skip_diff_gate }}'

          case "${ENVIRONMENT}" in
            staging|production) ;;
            *) echo "ERROR: invalid environment: ${ENVIRONMENT}" >&2; exit 1;;
          esac

          case "${ENABLE_HTTPS}" in
            true|false) ;;
            *) echo "ERROR: invalid enable_https (true/false): ${ENABLE_HTTPS}" >&2; exit 1;;
          esac

          case "${SKIP_DIFF_GATE}" in
            true|false) ;;
            *) echo "ERROR: invalid skip_diff_gate (true/false): ${SKIP_DIFF_GATE}" >&2; exit 1;;
          esac

      - name: Guard AWS_DEPLOY_ROLE_ARN
        shell: bash
        run: |
          if [ -z "${{ secrets.AWS_DEPLOY_ROLE_ARN }}" ]; then
            echo "ERROR: AWS_DEPLOY_ROLE_ARN is missing" >&2
            exit 1
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Guard: afu9/database secret not pending deletion
        shell: bash
        run: |
          set -euo pipefail
          SECRET_ID="afu9/database"
          if ! aws secretsmanager describe-secret --secret-id "${SECRET_ID}" --region "${{ env.AWS_REGION }}" >/dev/null 2>&1; then
            echo "Secret does not exist yet; CDK can create it."
            exit 0
          fi

          DELETED_DATE=$(aws secretsmanager describe-secret --secret-id "${SECRET_ID}" --region "${{ env.AWS_REGION }}" --query 'DeletedDate' --output text)
          if [ "${DELETED_DATE}" != "None" ]; then
            echo "ERROR: Secret ${SECRET_ID} is marked for deletion (${DELETED_DATE})." >&2
            echo "Remediation: aws secretsmanager delete-secret --secret-id ${SECRET_ID} --force-delete-without-recovery --region ${{ env.AWS_REGION }}" >&2
            exit 1
          fi

      - name: Diff gate
        if: ${{ inputs.skip_diff_gate != 'true' }}
        shell: bash
        run: |
          npm run validate:diff -- Afu9DatabaseStack \
            -c environment=${{ inputs.environment }} \
            -c afu9-domain=${{ env.DOMAIN_NAME }} \
            -c afu9-multi-env=false \
            -c afu9-enable-https=${{ inputs.enable_https }} \
            -c afu9-manage-dns=false \
            -c afu9-create-staging-service=${{ env.CREATE_STAGING_SERVICE }}

      - name: Deploy
        shell: bash
        run: |
          npx cdk deploy Afu9DatabaseStack \
            --context environment=${{ inputs.environment }} \
            --context afu9-domain=${{ env.DOMAIN_NAME }} \
            --context afu9-multi-env=false \
            --context afu9-enable-https=${{ inputs.enable_https }} \
            --context afu9-manage-dns=false \
            --context afu9-create-staging-service=${{ env.CREATE_STAGING_SERVICE }} \
            --require-approval never
