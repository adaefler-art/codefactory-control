name: Build Determinism Check

on:
  pull_request:
    paths:
      - 'control-center/**'
      - 'mcp-servers/**'
      - '**/Dockerfile'
      - '**/package.json'
      - '**/package-lock.json'
      - '.github/workflows/build-determinism.yml'
  push:
    branches:
      - main
    paths:
      - 'control-center/**'
      - 'mcp-servers/**'
      - '**/Dockerfile'
  workflow_dispatch:

jobs:
  verify-determinism:
    name: Verify Build Determinism
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Control Center (Build 1)
        id: build-cc-1
        uses: docker/build-push-action@v5
        with:
          context: ./control-center
          file: ./control-center/Dockerfile
          push: false
          load: true
          tags: test-control-center:1
          no-cache: true

      - name: Build Control Center (Build 2)
        id: build-cc-2
        uses: docker/build-push-action@v5
        with:
          context: ./control-center
          file: ./control-center/Dockerfile
          push: false
          load: true
          tags: test-control-center:2
          no-cache: true

      - name: Verify Control Center Determinism
        run: |
          DIGEST1=$(docker inspect test-control-center:1 --format='{{.Id}}')
          DIGEST2=$(docker inspect test-control-center:2 --format='{{.Id}}')
          
          echo "Control Center Build 1: $DIGEST1"
          echo "Control Center Build 2: $DIGEST2"
          
          if [ "$DIGEST1" != "$DIGEST2" ]; then
            echo "❌ Control Center build is non-deterministic!"
            exit 1
          fi
          
          echo "✅ Control Center build is deterministic"

      - name: Build MCP GitHub (Build 1)
        uses: docker/build-push-action@v5
        with:
          context: ./mcp-servers
          file: ./mcp-servers/github/Dockerfile
          push: false
          load: true
          tags: test-mcp-github:1
          no-cache: true

      - name: Build MCP GitHub (Build 2)
        uses: docker/build-push-action@v5
        with:
          context: ./mcp-servers
          file: ./mcp-servers/github/Dockerfile
          push: false
          load: true
          tags: test-mcp-github:2
          no-cache: true

      - name: Verify MCP GitHub Determinism
        run: |
          DIGEST1=$(docker inspect test-mcp-github:1 --format='{{.Id}}')
          DIGEST2=$(docker inspect test-mcp-github:2 --format='{{.Id}}')
          
          echo "MCP GitHub Build 1: $DIGEST1"
          echo "MCP GitHub Build 2: $DIGEST2"
          
          if [ "$DIGEST1" != "$DIGEST2" ]; then
            echo "❌ MCP GitHub build is non-deterministic!"
            exit 1
          fi
          
          echo "✅ MCP GitHub build is deterministic"

      - name: Build MCP Deploy (Build 1)
        uses: docker/build-push-action@v5
        with:
          context: ./mcp-servers
          file: ./mcp-servers/deploy/Dockerfile
          push: false
          load: true
          tags: test-mcp-deploy:1
          no-cache: true

      - name: Build MCP Deploy (Build 2)
        uses: docker/build-push-action@v5
        with:
          context: ./mcp-servers
          file: ./mcp-servers/deploy/Dockerfile
          push: false
          load: true
          tags: test-mcp-deploy:2
          no-cache: true

      - name: Verify MCP Deploy Determinism
        run: |
          DIGEST1=$(docker inspect test-mcp-deploy:1 --format='{{.Id}}')
          DIGEST2=$(docker inspect test-mcp-deploy:2 --format='{{.Id}}')
          
          echo "MCP Deploy Build 1: $DIGEST1"
          echo "MCP Deploy Build 2: $DIGEST2"
          
          if [ "$DIGEST1" != "$DIGEST2" ]; then
            echo "❌ MCP Deploy build is non-deterministic!"
            exit 1
          fi
          
          echo "✅ MCP Deploy build is deterministic"

      - name: Build MCP Observability (Build 1)
        uses: docker/build-push-action@v5
        with:
          context: ./mcp-servers
          file: ./mcp-servers/observability/Dockerfile
          push: false
          load: true
          tags: test-mcp-observability:1
          no-cache: true

      - name: Build MCP Observability (Build 2)
        uses: docker/build-push-action@v5
        with:
          context: ./mcp-servers
          file: ./mcp-servers/observability/Dockerfile
          push: false
          load: true
          tags: test-mcp-observability:2
          no-cache: true

      - name: Verify MCP Observability Determinism
        run: |
          DIGEST1=$(docker inspect test-mcp-observability:1 --format='{{.Id}}')
          DIGEST2=$(docker inspect test-mcp-observability:2 --format='{{.Id}}')
          
          echo "MCP Observability Build 1: $DIGEST1"
          echo "MCP Observability Build 2: $DIGEST2"
          
          if [ "$DIGEST1" != "$DIGEST2" ]; then
            echo "❌ MCP Observability build is non-deterministic!"
            exit 1
          fi
          
          echo "✅ MCP Observability build is deterministic"

      - name: Summary
        if: success()
        run: |
          echo "## Build Determinism Verification ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All builds are deterministic! Same inputs produced identical outputs." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verified Components:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Control Center" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ MCP GitHub Server" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ MCP Deploy Server" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ MCP Observability Server" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Determinism Score: 100%**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Target: ≥95% (Achieved: 100%)" >> $GITHUB_STEP_SUMMARY

      - name: Failure Summary
        if: failure()
        run: |
          echo "## Build Determinism Verification ❌" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Some builds are non-deterministic. Please review the logs above." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Common Causes:" >> $GITHUB_STEP_SUMMARY
          echo "- Timestamps in build artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Non-pinned dependency versions" >> $GITHUB_STEP_SUMMARY
          echo "- Random values in code" >> $GITHUB_STEP_SUMMARY
          echo "- Missing SOURCE_DATE_EPOCH" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See [Build Determinism Criteria](docs/BUILD_DETERMINISM_CRITERIA.md) for details." >> $GITHUB_STEP_SUMMARY
