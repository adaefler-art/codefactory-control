name: Build Determinism Check

on:
  pull_request:
    paths:
      - 'control-center/**'
      - 'mcp-servers/**'
      - '**/Dockerfile'
      - '**/package.json'
      - '**/package-lock.json'
      - '.github/workflows/build-determinism.yml'
  push:
    branches:
      - main
    paths:
      - 'control-center/**'
      - 'mcp-servers/**'
      - '**/Dockerfile'
  workflow_dispatch:

jobs:
  verify-determinism:
    name: Verify Build Determinism
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate deterministic build inputs
        id: det
        shell: bash
        run: |
          # Keep the two back-to-back builds byte-for-byte identical by
          # reusing the same preview-mode keys + build timestamp.
          echo "build_timestamp=2000-01-01T00:00:00.000Z" >> "$GITHUB_OUTPUT"
          echo "preview_id=$(openssl rand -hex 16)" >> "$GITHUB_OUTPUT"
          echo "preview_signing_key=$(openssl rand -hex 32)" >> "$GITHUB_OUTPUT"
          echo "preview_encryption_key=$(openssl rand -hex 32)" >> "$GITHUB_OUTPUT"

      - name: Build Control Center (Build 1)
        id: build-cc-1
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./control-center/Dockerfile
          push: false
          load: true
          tags: test-control-center:1
          no-cache: true
          provenance: false
          sbom: false
          build-args: |
            BUILD_VERSION=0.0.0-determinism
            BUILD_COMMIT_HASH=${{ github.sha }}
            BUILD_ENV=determinism
            BUILD_TIMESTAMP=${{ steps.det.outputs.build_timestamp }}
            NEXT_PREVIEW_MODE_ID=${{ steps.det.outputs.preview_id }}
            NEXT_PREVIEW_MODE_SIGNING_KEY=${{ steps.det.outputs.preview_signing_key }}
            NEXT_PREVIEW_MODE_ENCRYPTION_KEY=${{ steps.det.outputs.preview_encryption_key }}

      - name: Build Control Center (Build 2)
        id: build-cc-2
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./control-center/Dockerfile
          push: false
          load: true
          tags: test-control-center:2
          no-cache: true
          provenance: false
          sbom: false
          build-args: |
            BUILD_VERSION=0.0.0-determinism
            BUILD_COMMIT_HASH=${{ github.sha }}
            BUILD_ENV=determinism
            BUILD_TIMESTAMP=${{ steps.det.outputs.build_timestamp }}
            NEXT_PREVIEW_MODE_ID=${{ steps.det.outputs.preview_id }}
            NEXT_PREVIEW_MODE_SIGNING_KEY=${{ steps.det.outputs.preview_signing_key }}
            NEXT_PREVIEW_MODE_ENCRYPTION_KEY=${{ steps.det.outputs.preview_encryption_key }}

      - name: Verify Control Center Determinism (RootFS)
        run: |
          LAYERS1=$(docker inspect test-control-center:1 --format='{{json .RootFS.Layers}}')
          LAYERS2=$(docker inspect test-control-center:2 --format='{{json .RootFS.Layers}}')
          ID1=$(docker inspect test-control-center:1 --format='{{.Id}}')
          ID2=$(docker inspect test-control-center:2 --format='{{.Id}}')

          echo "Control Center Image 1 Id: $ID1"
          echo "Control Center Image 2 Id: $ID2"
          echo "Control Center Layers 1: $LAYERS1"
          echo "Control Center Layers 2: $LAYERS2"

          if [ "$LAYERS1" != "$LAYERS2" ]; then
            echo "❌ Control Center root filesystem layers differ (non-deterministic content)!"
            exit 1
          fi

          echo "✅ Control Center root filesystem layers are deterministic"


      - name: Build MCP GitHub (Build 1)
        uses: docker/build-push-action@v5
        with:
          context: ./mcp-servers
          file: ./mcp-servers/github/Dockerfile
          push: false
          load: true
          tags: test-mcp-github:1
          no-cache: true

      - name: Build MCP GitHub (Build 2)
        uses: docker/build-push-action@v5
        with:
          context: ./mcp-servers
          file: ./mcp-servers/github/Dockerfile
          push: false
          load: true
          tags: test-mcp-github:2
          no-cache: true

      - name: Verify MCP GitHub Determinism
        run: |
          LAYERS1=$(docker inspect test-mcp-github:1 --format='{{json .RootFS.Layers}}')
          LAYERS2=$(docker inspect test-mcp-github:2 --format='{{json .RootFS.Layers}}')
          ID1=$(docker inspect test-mcp-github:1 --format='{{.Id}}')
          ID2=$(docker inspect test-mcp-github:2 --format='{{.Id}}')

          echo "MCP GitHub Image 1 Id: $ID1"
          echo "MCP GitHub Image 2 Id: $ID2"
          echo "MCP GitHub Layers 1: $LAYERS1"
          echo "MCP GitHub Layers 2: $LAYERS2"

          if [ "$LAYERS1" != "$LAYERS2" ]; then
            echo "❌ MCP GitHub root filesystem layers differ (non-deterministic content)!"
            exit 1
          fi

          echo "✅ MCP GitHub root filesystem layers are deterministic"

      - name: Build MCP Deploy (Build 1)
        uses: docker/build-push-action@v5
        with:
          context: ./mcp-servers
          file: ./mcp-servers/deploy/Dockerfile
          push: false
          load: true
          tags: test-mcp-deploy:1
          no-cache: true

      - name: Build MCP Deploy (Build 2)
        uses: docker/build-push-action@v5
        with:
          context: ./mcp-servers
          file: ./mcp-servers/deploy/Dockerfile
          push: false
          load: true
          tags: test-mcp-deploy:2
          no-cache: true

      - name: Verify MCP Deploy Determinism
        run: |
          LAYERS1=$(docker inspect test-mcp-deploy:1 --format='{{json .RootFS.Layers}}')
          LAYERS2=$(docker inspect test-mcp-deploy:2 --format='{{json .RootFS.Layers}}')
          ID1=$(docker inspect test-mcp-deploy:1 --format='{{.Id}}')
          ID2=$(docker inspect test-mcp-deploy:2 --format='{{.Id}}')

          echo "MCP Deploy Image 1 Id: $ID1"
          echo "MCP Deploy Image 2 Id: $ID2"
          echo "MCP Deploy Layers 1: $LAYERS1"
          echo "MCP Deploy Layers 2: $LAYERS2"

          if [ "$LAYERS1" != "$LAYERS2" ]; then
            echo "❌ MCP Deploy root filesystem layers differ (non-deterministic content)!"
            exit 1
          fi

          echo "✅ MCP Deploy root filesystem layers are deterministic"

      - name: Build MCP Observability (Build 1)
        uses: docker/build-push-action@v5
        with:
          context: ./mcp-servers
          file: ./mcp-servers/observability/Dockerfile
          push: false
          load: true
          tags: test-mcp-observability:1
          no-cache: true

      - name: Build MCP Observability (Build 2)
        uses: docker/build-push-action@v5
        with:
          context: ./mcp-servers
          file: ./mcp-servers/observability/Dockerfile
          push: false
          load: true
          tags: test-mcp-observability:2
          no-cache: true

      - name: Verify MCP Observability Determinism
        run: |
          LAYERS1=$(docker inspect test-mcp-observability:1 --format='{{json .RootFS.Layers}}')
          LAYERS2=$(docker inspect test-mcp-observability:2 --format='{{json .RootFS.Layers}}')
          ID1=$(docker inspect test-mcp-observability:1 --format='{{.Id}}')
          ID2=$(docker inspect test-mcp-observability:2 --format='{{.Id}}')

          echo "MCP Observability Image 1 Id: $ID1"
          echo "MCP Observability Image 2 Id: $ID2"
          echo "MCP Observability Layers 1: $LAYERS1"
          echo "MCP Observability Layers 2: $LAYERS2"

          if [ "$LAYERS1" != "$LAYERS2" ]; then
            echo "❌ MCP Observability root filesystem layers differ (non-deterministic content)!"
            exit 1
          fi

          echo "✅ MCP Observability root filesystem layers are deterministic"

      - name: Summary
        if: success()
        run: |
          echo "## Build Determinism Verification ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All builds are deterministic! Same inputs produced identical outputs." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verified Components:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Control Center" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ MCP GitHub Server" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ MCP Deploy Server" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ MCP Observability Server" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Determinism Score: 100%**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Target: ≥95% (Achieved: 100%)" >> $GITHUB_STEP_SUMMARY

      - name: Failure Summary
        if: failure()
        run: |
          echo "## Build Determinism Verification ❌" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Some builds are non-deterministic. Please review the logs above." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Common Causes:" >> $GITHUB_STEP_SUMMARY
          echo "- Timestamps in build artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Non-pinned dependency versions" >> $GITHUB_STEP_SUMMARY
          echo "- Random values in code" >> $GITHUB_STEP_SUMMARY
          echo "- Missing SOURCE_DATE_EPOCH" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See [Build Determinism Criteria](docs/BUILD_DETERMINISM_CRITERIA.md) for details." >> $GITHUB_STEP_SUMMARY
